<app-header></app-header>
<main class="project-detail-main">
  <div class="breadcrumb">
    <a routerLink="/projects" class="breadcrumb-link">‚Üê Tous les projets</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ project?.name || 'Projet' }}</span>
  </div>

  <div *ngIf="loading" class="loading">Chargement du projet...</div>
  <div *ngIf="error" class="error-msg">{{ error }}</div>

  <div *ngIf="project && !loading" class="project-container">
    <div class="project-header">
      <div>
        <h1 class="project-name">{{ project.name }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>
      <div class="project-header-actions">
        <button routerLink="/projects/edit/{{ project.id }}" class="edit-project-header-btn" title="Modifier le projet">
          ‚úé Modifier le projet
        </button>
        <button (click)="openCreateStoryModal()" class="create-story-btn">+ User Story</button>
      </div>
    </div>

    <div class="project-members">
      <strong>Membres:</strong>
      <span class="member-badge owner">{{ project.owner.username }} (Propri√©taire)</span>
      <span *ngFor="let member of project.members.slice(0, project.members.length - 1)" class="member-badge">
        {{ member.username }}
      </span>
    </div>

    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column">
        <h2 class="column-title todo">√Ä Faire</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('TODO')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé Modifier</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column">
        <h2 class="column-title in-progress">En Cours</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('IN_PROGRESS')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé Modifier</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column">
        <h2 class="column-title done">Termin√©</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('DONE')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé Modifier</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<app-user-story-form
  [show]="showCreateStoryModal"
  [mode]="'create'"
  [members]="project?.members || []"
  [error]="userStoryError"
  (closeModal)="closeCreateStoryModal()"
  (submitForm)="onCreateUserStory($event)"
></app-user-story-form>

<app-user-story-form
  [show]="showEditStoryModal"
  [mode]="'edit'"
  [story]="currentEditingStory"
  [members]="project?.members || []"
  [error]="editUserStoryError"
  (closeModal)="closeEditStoryModal()"
  (submitForm)="onEditUserStory($event)"
></app-user-story-form>
