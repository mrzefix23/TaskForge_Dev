<app-header></app-header>
<main class="project-detail-main">
  <div class="breadcrumb">
    <a routerLink="/projects" class="breadcrumb-link">‚Üê Tous les projets</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ project?.name || 'Projet' }}</span>
  </div>

  <div *ngIf="loading" class="loading">Chargement du projet...</div>
  <div *ngIf="error" class="error-msg">{{ error }}</div>

  <div *ngIf="project && !loading" class="project-container">
    <div class="project-header">
      <div>
        <h1 class="project-name">{{ project.name }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>
      <div class="project-header-actions">
        <button (click)="goToVersionManagement()" class="manage-versions-btn" title="G√©rer les versions">
          üì¶ Versions
        </button>
        <button (click)="goToSprintManagement()" class="manage-sprint-btn" title="G√©rer les sprints">
          üìã G√©rer les Sprints
        </button>
        <button routerLink="/projects/edit/{{ project.id }}" class="edit-project-header-btn" title="Modifier le projet">
          ‚úé Modifier le projet
        </button>
        <button (click)="openCreateStoryModal()" class="create-story-btn">+ User Story</button>
      </div>
    </div>

    <div class="project-members">
      <strong>Membres:</strong>
      <span class="member-badge owner-badge">
        {{ project.owner.username }} (Propri√©taire)
      </span>
      <ng-container *ngFor="let member of project.members">
        <span *ngIf="member.username !== project.owner.username" class="member-badge">
        {{ member.username }}
        </span>
      </ng-container>
    </div>

    <!-- Sprint Filter -->
    <div class="sprint-filter">
      <label for="sprintFilter">Filtrer par sprint:</label>
      <select id="sprintFilter" [(ngModel)]="selectedSprintFilter" class="sprint-select">
        <option value="all">Toutes les user stories</option>
        <option value="backlog">Backlog (sans sprint)</option>
        <option *ngFor="let sprint of sprints" [value]="sprint.id">
          {{ sprint.name }} ({{ sprint.status }})
        </option>
      </select>
      <button (click)="openAddColumnModal()" class="add-column-btn" title="Ajouter une colonne">+ Colonne</button>
    </div>

    <div class="kanban-board" cdkDropListGroup>
      <!-- Dynamic Columns -->
      <div *ngFor="let column of kanbanColumns" class="kanban-column">
        <div class="column-header">
          <h2 class="column-title" [ngClass]="column.status.toLowerCase()">{{ column.name }}</h2>
          <div class="column-actions">
            <button (click)="openRenameColumnModal(column, $event)" class="rename-column-btn" title="Renommer la colonne">‚úé</button>
            <button *ngIf="!column.isDefault" (click)="deleteColumn(column, $event)" class="delete-column-btn" title="Supprimer la colonne">√ó</button>
          </div>
        </div>
        <div 
          class="story-list"
          cdkDropList
          [id]="'column-' + column.status"
          [cdkDropListData]="getStoriesByStatus(column.status)"
          [cdkDropListConnectedTo]="getConnectedDropLists()"
          (cdkDropListDropped)="onDrop($event, column.status)">
          <div *ngFor="let story of getStoriesByStatus(column.status)" class="story-card" cdkDrag>
            <div class="story-card-header">
              <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
              <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé</button>
            </div>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            
            <!-- Status Selector -->
            <div class="story-status-selector">
              <label>Statut:</label>
              <select [(ngModel)]="story.status" (change)="changeStatus(story, story.status)" class="status-select">
                <option *ngFor="let col of kanbanColumns" [value]="col.status">{{ col.name }}</option>
              </select>
            </div>
            
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
            
            <!-- Tasks Section -->
            <div class="tasks-section">
              <div class="tasks-header">
                <button (click)="toggleTasks(story, $event)" class="toggle-tasks-btn">
                  <span [class.rotate]="!story.showTasks">‚ñº</span> {{ getTaskCountLabel(story) }}
                </button>
                <button (click)="openCreateTaskModal(story.id, $event)" class="add-task-btn" title="Ajouter une t√¢che">+ T√¢che</button>
              </div>
              
              <div *ngIf="story.showTasks" class="tasks-list">
                <div *ngFor="let task of story.tasks" class="task-item">
                  <div class="task-header">
                    <span class="task-status-badge" [ngClass]="task.status.toLowerCase()">{{ getStatusLabel(task.status) }}</span>
                    <div class="task-actions">
                      <button (click)="openEditTaskModal(task, $event)" class="task-edit-btn" title="Modifier">‚úé</button>
                      <button (click)="deleteTask(task.id, story.id, $event)" class="task-delete-btn" title="Supprimer">√ó</button>
                    </div>
                  </div>
                  <h4 class="task-title">{{ task.title }}</h4>
                  <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
                  <div class="task-footer">
                    <span class="task-priority-badge" [ngClass]="task.priority.toLowerCase()">{{ getPriorityLabel(task.priority) }}</span>
                    <span *ngIf="task.assignedTo" class="task-assignee">üë§ {{ task.assignedTo.username }}</span>
                  </div>
                </div>
                <div *ngIf="!story.tasks || story.tasks.length === 0" class="no-tasks">
                  Aucune t√¢che pour le moment
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<app-user-story-form
  [show]="showCreateStoryModal"
  [mode]="'create'"
  [members]="project?.members || []"
  [kanbanColumns]="kanbanColumns"
  [error]="userStoryError"
  (closeModal)="closeCreateStoryModal()"
  (submitForm)="onCreateUserStory($event)"
></app-user-story-form>

<app-user-story-form
  [show]="showEditStoryModal"
  [mode]="'edit'"
  [story]="currentEditingStory"
  [members]="project?.members || []"
  [kanbanColumns]="kanbanColumns"
  [error]="editUserStoryError"
  (closeModal)="closeEditStoryModal()"
  (submitForm)="onEditUserStory($event)"
></app-user-story-form>

<app-task-form
  [show]="showCreateTaskModal"
  [mode]="'create'"
  [members]="project?.members || []"
  [error]="taskError"
  (closeModal)="closeCreateTaskModal()"
  (submitForm)="onCreateTask($event)"
></app-task-form>

<app-task-form
  [show]="showEditTaskModal"
  [mode]="'edit'"
  [task]="currentEditingTask"
  [members]="project?.members || []"
  [error]="editTaskError"
  (closeModal)="closeEditTaskModal()"
  (submitForm)="onEditTask($event)"
></app-task-form>

<!-- Modal Supprimer User Story -->
<div *ngIf="showDeleteStoryModal" class="modal-overlay" (click)="closeDeleteStoryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la suppression</h2>
      <button class="close-btn" (click)="closeDeleteStoryModal()">√ó</button>
    </div>
    <p>√ätes-vous s√ªr de vouloir supprimer la User Story "{{ storyToDelete?.title }}" ?</p>
    <p class="warning">Toutes les t√¢ches associ√©es seront √©galement supprim√©es.</p>
    <div *ngIf="deleteError" class="alert alert-error">{{ deleteError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeDeleteStoryModal()">Annuler</button>
      <button class="btn-danger" (click)="confirmDeleteUserStory()">Supprimer</button>
    </div>
  </div>
</div>

<!-- Modal Supprimer T√¢che -->
<div *ngIf="showDeleteTaskModal" class="modal-overlay" (click)="closeDeleteTaskModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la suppression</h2>
      <button class="close-btn" (click)="closeDeleteTaskModal()">√ó</button>
    </div>
    <p>√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?</p>
    <div *ngIf="deleteError" class="alert alert-error">{{ deleteError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeDeleteTaskModal()">Annuler</button>
      <button class="btn-danger" (click)="confirmDeleteTask()">Supprimer</button>
    </div>
  </div>
</div>

<!-- Modal Ajouter une Colonne -->
<div *ngIf="showAddColumnModal" class="modal-overlay" (click)="closeAddColumnModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Ajouter une Colonne</h2>
      <button class="close-btn" (click)="closeAddColumnModal()">√ó</button>
    </div>
    <div class="form-group">
      <label for="columnName">Nom de la colonne:</label>
      <input 
        type="text" 
        id="columnName" 
        [(ngModel)]="newColumnName" 
        class="form-control" 
        placeholder="Ex: En revue, Bloqu√©..."
        (keyup.enter)="addColumn()">
    </div>
    <div class="form-group">
      <label for="columnOrder">Ordre:</label>
      <input 
        type="number" 
        id="columnOrder" 
        [(ngModel)]="newColumnOrder" 
        class="form-control" 
        min="1">
    </div>
    <div *ngIf="columnError" class="alert alert-error">{{ columnError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeAddColumnModal()">Annuler</button>
      <button class="btn-primary" (click)="addColumn()">Ajouter</button>
    </div>
  </div>
</div>

<!-- Modal Renommer une Colonne -->
<div *ngIf="showRenameColumnModal" class="modal-overlay" (click)="closeRenameColumnModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Renommer la Colonne</h2>
      <button class="close-btn" (click)="closeRenameColumnModal()">√ó</button>
    </div>
    <div class="form-group">
      <label for="renameColumnName">Nouveau nom:</label>
      <input 
        type="text" 
        id="renameColumnName" 
        [(ngModel)]="renameColumnName" 
        class="form-control" 
        placeholder="Nom de la colonne"
        (keyup.enter)="renameColumn()">
    </div>
    <div *ngIf="renameError" class="alert alert-error">{{ renameError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeRenameColumnModal()">Annuler</button>
      <button class="btn-primary" (click)="renameColumn()">Renommer</button>
    </div>
  </div>
</div>
