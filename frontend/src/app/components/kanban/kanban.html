<app-header></app-header>
<main class="project-detail-main">
  <div class="breadcrumb">
    <a routerLink="/projects" class="breadcrumb-link">‚Üê Tous les projets</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">{{ project?.name || 'Projet' }}</span>
  </div>

  <div *ngIf="loading" class="loading">Chargement du projet...</div>
  <div *ngIf="error" class="error-msg">{{ error }}</div>

  <div *ngIf="project && !loading" class="project-container">
    <div class="project-header">
      <div>
        <h1 class="project-name">{{ project.name }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>
      <div class="project-header-actions">
        <button (click)="goToSprintManagement()" class="manage-sprint-btn" title="G√©rer les sprints">
          üìã G√©rer les Sprints
        </button>
        <button routerLink="/projects/edit/{{ project.id }}" class="edit-project-header-btn" title="Modifier le projet">
          ‚úé Modifier le projet
        </button>
        <button (click)="openCreateStoryModal()" class="create-story-btn">+ User Story</button>
      </div>
    </div>

    <div class="project-members">
      <strong>Membres:</strong>
      <span class="member-badge owner-badge">
        {{ project.owner.username }} (Propri√©taire)
      </span>
      <ng-container *ngFor="let member of project.members">
        <span *ngIf="member.username !== project.owner.username" class="member-badge">
        {{ member.username }}
        </span>
      </ng-container>
    </div>

    <!-- Sprint Filter -->
    <div class="sprint-filter">
      <label for="sprintFilter">Filtrer par sprint:</label>
      <select id="sprintFilter" [(ngModel)]="selectedSprintFilter" class="sprint-select">
        <option value="all">Toutes les user stories</option>
        <option value="backlog">Backlog (sans sprint)</option>
        <option *ngFor="let sprint of sprints" [value]="sprint.id">
          {{ sprint.name }} ({{ sprint.status }})
        </option>
      </select>
    </div>

    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column">
        <h2 class="column-title todo">√Ä Faire</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('TODO')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
            
            <!-- Tasks Section -->
            <div class="tasks-section">
              <div class="tasks-header">
                <button (click)="toggleTasks(story, $event)" class="toggle-tasks-btn">
                  <span [class.rotate]="!story.showTasks">‚ñº</span> {{ getTaskCountLabel(story) }}
                </button>
                <button (click)="openCreateTaskModal(story.id, $event)" class="add-task-btn" title="Ajouter une t√¢che">+ T√¢che</button>
              </div>
              
              <div *ngIf="story.showTasks" class="tasks-list">
                <div *ngFor="let task of story.tasks" class="task-item">
                  <div class="task-header">
                    <span class="task-status-badge" [ngClass]="task.status.toLowerCase()">{{ getStatusLabel(task.status) }}</span>
                    <div class="task-actions">
                      <button (click)="openEditTaskModal(task, $event)" class="task-edit-btn" title="Modifier">‚úé</button>
                      <button (click)="deleteTask(task.id, story.id, $event)" class="task-delete-btn" title="Supprimer">√ó</button>
                    </div>
                  </div>
                  <h4 class="task-title">{{ task.title }}</h4>
                  <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
                  <div class="task-footer">
                    <span class="task-priority-badge" [ngClass]="task.priority.toLowerCase()">{{ getPriorityLabel(task.priority) }}</span>
                    <span *ngIf="task.assignedTo" class="task-assignee">üë§ {{ task.assignedTo.username }}</span>
                  </div>
                </div>
                <div *ngIf="!story.tasks || story.tasks.length === 0" class="no-tasks">
                  Aucune t√¢che pour le moment
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column">
        <h2 class="column-title in-progress">En Cours</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('IN_PROGRESS')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
            
            <!-- Tasks Section -->
            <div class="tasks-section">
              <div class="tasks-header">
                <button (click)="toggleTasks(story, $event)" class="toggle-tasks-btn">
                  <span [class.rotate]="!story.showTasks">‚ñº</span> {{ getTaskCountLabel(story) }}
                </button>
                <button (click)="openCreateTaskModal(story.id, $event)" class="add-task-btn" title="Ajouter une t√¢che">+ T√¢che</button>
              </div>
              
              <div *ngIf="story.showTasks" class="tasks-list">
                <div *ngFor="let task of story.tasks" class="task-item">
                  <div class="task-header">
                    <span class="task-status-badge" [ngClass]="task.status.toLowerCase()">{{ getStatusLabel(task.status) }}</span>
                    <div class="task-actions">
                      <button (click)="openEditTaskModal(task, $event)" class="task-edit-btn" title="Modifier">‚úé</button>
                      <button (click)="deleteTask(task.id, story.id, $event)" class="task-delete-btn" title="Supprimer">√ó</button>
                    </div>
                  </div>
                  <h4 class="task-title">{{ task.title }}</h4>
                  <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
                  <div class="task-footer">
                    <span class="task-priority-badge" [ngClass]="task.priority.toLowerCase()">{{ getPriorityLabel(task.priority) }}</span>
                    <span *ngIf="task.assignedTo" class="task-assignee">üë§ {{ task.assignedTo.username }}</span>
                  </div>
                </div>
                <div *ngIf="!story.tasks || story.tasks.length === 0" class="no-tasks">
                  Aucune t√¢che pour le moment
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column">
        <h2 class="column-title done">Termin√©</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('DONE')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <button (click)="openEditStoryModal(story, $event)" class="edit-story-btn" title="Modifier">‚úé</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">
              <span class="priority-badge">{{ getPriorityLabel(story.priority) }}</span>
            </p>
            <p class="story-description" *ngIf="story.description">{{ story.description }}</p>
            <div *ngIf="story.assignedTo && story.assignedTo.length > 0" class="story-assignee">
              üë§ <span *ngFor="let assignee of story.assignedTo; let isLast = last">{{ assignee.username }}{{ !isLast ? ', ' : '' }}</span>
            </div>
            
            <!-- Tasks Section -->
            <div class="tasks-section">
              <div class="tasks-header">
                <button (click)="toggleTasks(story, $event)" class="toggle-tasks-btn">
                  <span [class.rotate]="!story.showTasks">‚ñº</span> {{ getTaskCountLabel(story) }}
                </button>
                <button (click)="openCreateTaskModal(story.id, $event)" class="add-task-btn" title="Ajouter une t√¢che">+ T√¢che</button>
              </div>
              
              <div *ngIf="story.showTasks" class="tasks-list">
                <div *ngFor="let task of story.tasks" class="task-item">
                  <div class="task-header">
                    <span class="task-status-badge" [ngClass]="task.status.toLowerCase()">{{ getStatusLabel(task.status) }}</span>
                    <div class="task-actions">
                      <button (click)="openEditTaskModal(task, $event)" class="task-edit-btn" title="Modifier">‚úé</button>
                      <button (click)="deleteTask(task.id, story.id, $event)" class="task-delete-btn" title="Supprimer">√ó</button>
                    </div>
                  </div>
                  <h4 class="task-title">{{ task.title }}</h4>
                  <p *ngIf="task.description" class="task-description">{{ task.description }}</p>
                  <div class="task-footer">
                    <span class="task-priority-badge" [ngClass]="task.priority.toLowerCase()">{{ getPriorityLabel(task.priority) }}</span>
                    <span *ngIf="task.assignedTo" class="task-assignee">üë§ {{ task.assignedTo.username }}</span>
                  </div>
                </div>
                <div *ngIf="!story.tasks || story.tasks.length === 0" class="no-tasks">
                  Aucune t√¢che pour le moment
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<app-user-story-form
  [show]="showCreateStoryModal"
  [mode]="'create'"
  [members]="project?.members || []"
  [error]="userStoryError"
  (closeModal)="closeCreateStoryModal()"
  (submitForm)="onCreateUserStory($event)"
></app-user-story-form>

<app-user-story-form
  [show]="showEditStoryModal"
  [mode]="'edit'"
  [story]="currentEditingStory"
  [members]="project?.members || []"
  [error]="editUserStoryError"
  (closeModal)="closeEditStoryModal()"
  (submitForm)="onEditUserStory($event)"
></app-user-story-form>

<app-task-form
  [show]="showCreateTaskModal"
  [mode]="'create'"
  [members]="project?.members || []"
  [error]="taskError"
  (closeModal)="closeCreateTaskModal()"
  (submitForm)="onCreateTask($event)"
></app-task-form>

<app-task-form
  [show]="showEditTaskModal"
  [mode]="'edit'"
  [task]="currentEditingTask"
  [members]="project?.members || []"
  [error]="editTaskError"
  (closeModal)="closeEditTaskModal()"
  (submitForm)="onEditTask($event)"
></app-task-form>

<!-- Modal Supprimer User Story -->
<div *ngIf="showDeleteStoryModal" class="modal-overlay" (click)="closeDeleteStoryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la suppression</h2>
      <button class="close-btn" (click)="closeDeleteStoryModal()">√ó</button>
    </div>
    <p>√ätes-vous s√ªr de vouloir supprimer la User Story "{{ storyToDelete?.title }}" ?</p>
    <p class="warning">Toutes les t√¢ches associ√©es seront √©galement supprim√©es.</p>
    <div *ngIf="deleteError" class="alert alert-error">{{ deleteError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeDeleteStoryModal()">Annuler</button>
      <button class="btn-danger" (click)="confirmDeleteUserStory()">Supprimer</button>
    </div>
  </div>
</div>

<!-- Modal Supprimer T√¢che -->
<div *ngIf="showDeleteTaskModal" class="modal-overlay" (click)="closeDeleteTaskModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la suppression</h2>
      <button class="close-btn" (click)="closeDeleteTaskModal()">√ó</button>
    </div>
    <p>√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?</p>
    <div *ngIf="deleteError" class="alert alert-error">{{ deleteError }}</div>
    <div class="modal-actions">
      <button class="btn-secondary" (click)="closeDeleteTaskModal()">Annuler</button>
      <button class="btn-danger" (click)="confirmDeleteTask()">Supprimer</button>
    </div>
  </div>
</div>
