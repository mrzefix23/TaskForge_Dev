<app-header></app-header>
<main class="project-detail-main">
  <div *ngIf="loading" class="loading">Chargement du projet...</div>
  <div *ngIf="error" class="error-msg">{{ error }}</div>

  <div *ngIf="project && !loading" class="project-container">
    <div class="project-header">
      <div>
        <h1 class="project-name">{{ project.name }}</h1>
        <p class="project-description">{{ project.description }}</p>
      </div>
      <button (click)="openCreateStoryModal()" class="create-story-btn">Cr√©er une User Story</button>
    </div>

    <div class="project-members">
      <strong>Membres:</strong>
      <span class="member-badge owner">{{ project.owner.username }} (Propri√©taire)</span>
      <span *ngFor="let member of project.members | slice:1" class="member-badge">
        {{ member.username }}
      </span>
    </div>

    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column">
        <h2 class="column-title todo">√Ä Faire</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('TODO')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">{{ story.priority }}</p>
            <div *ngIf="story.assignedTo" class="story-assignee">
              üë§ {{ story.assignedTo.username }}
            </div>
          </div>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column">
        <h2 class="column-title in-progress">En Cours</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('IN_PROGRESS')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">{{ story.priority }}</p>
            <div *ngIf="story.assignedTo" class="story-assignee">
              üë§ {{ story.assignedTo.username }}
            </div>
          </div>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column">
        <h2 class="column-title done">Termin√©</h2>
        <div class="story-list">
          <div *ngFor="let story of getStoriesByStatus('DONE')" class="story-card">
            <button (click)="deleteUserStory(story.id, $event)" class="delete-story-btn" title="Supprimer">√ó</button>
            <h3 class="story-title">{{ story.title }}</h3>
            <p class="story-priority" [ngClass]="story.priority.toLowerCase()">{{ story.priority }}</p>
            <div *ngIf="story.assignedTo" class="story-assignee">
              üë§ {{ story.assignedTo.username }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Create User Story Modal -->
<div *ngIf="showCreateStoryModal" class="modal-overlay" (click)="closeCreateStoryModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Cr√©er une User Story</h2>
    <form [formGroup]="userStoryForm" (ngSubmit)="onUserStorySubmit()">
      <div class="form-group">
        <label for="story-title">Titre</label>
        <input id="story-title" formControlName="title" required>
      </div>
      <div class="form-group">
        <label for="story-desc">Description</label>
        <textarea id="story-desc" formControlName="description"></textarea>
      </div>
      <div class="form-group">
        <label for="story-priority">Priorit√©</label>
        <select id="story-priority" formControlName="priority">
          <option value="LOW">Basse</option>
          <option value="MEDIUM">Moyenne</option>
          <option value="HIGH">Haute</option>
        </select>
      </div>
      <div class="form-group" *ngIf="project">
        <label for="story-assignee">Assigner √†</label>
        <select id="story-assignee" formControlName="assignedToUsername">
          <option value="">Non assign√©</option>
          <option *ngFor="let member of project.members" [value]="member.username">
            {{ member.username }}
          </option>
        </select>
      </div>
      <div *ngIf="userStoryError" class="error-msg modal-error">
        {{ userStoryError }}
      </div>
      <div class="modal-actions">
        <button type="button" (click)="closeCreateStoryModal()" class="cancel-btn">Annuler</button>
        <button type="submit" [disabled]="userStoryForm.invalid" class="submit-btn">Cr√©er</button>
      </div>
    </form>
  </div>
</div>
