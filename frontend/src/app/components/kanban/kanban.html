<div class="kanban-filters">
  <div>
    <label>Sprint: </label>
    <select [(ngModel)]="selectedSprint">
      <option value="">All</option>
      <option *ngFor="let sprintId of [1, 2, 3]" [value]="sprintId">Sprint {{ sprintId }}</option>
    </select>
  </div>
  <div>
    <label>Priority: </label>
    <select [(ngModel)]="selectedPriority">
      <option value="">All</option>
      <option value="High">High</option>
      <option value="Medium">Medium</option>
      <option value="Low">Low</option>
    </select>
  </div>
</div>


<div class="flex items-center max-w-7xl mx-auto gap-4 mt-4 mb-2">
  <div class="flex-1"></div>
  <div>
    <button class="add-task-btn" (click)="addColumn()">＋</button>
  </div>
</div>

<div class="flex max-w-7xl mx-auto gap-4 mt-4">
  <div *ngFor="let col of columns" class="relative bg-gray-200 w-full rounded-md p-4 flex-1 transition-colors duration-300" (drop)="onDrop($event, col.id)" (dragover)="$event.preventDefault()"
    draggable="true" (dragstart)="onColumnDragStart($event, col)" (dragend)="onColumnDragEnd($event)" [class.col-dragging]="draggingColumnId === col.id">
    <div class="flex items-center justify-between mb-4">
      <ng-container *ngIf="editingColumnId !== col.id; else editCol">
        <h3 class="font-bold text-lg text-gray-600">{{ col.label }}</h3>
        <div class="flex gap-2">
          <button class="add-task-btn" (click)="addTask(col.id)" title="Ajouter une tâche">＋</button>
          <button class="add-task-btn" (click)="startEditColumn(col)" title="Renommer la colonne">✎</button>
        </div>
      </ng-container>
      <ng-template #editCol>
        <input [id]="'col-input-' + getSafeId(col.id)" class="kanban-input" [(ngModel)]="editedColumnLabel" (keydown.enter)="saveColumn(col)" (blur)="saveColumn(col)" />
      </ng-template>
    </div>

    <div class="flex flex-col gap-4">
      <div *ngFor="let task of getTaskByStatus(col.id)" class="bg-white px-5 py-3 rounded-md cursor-pointer transition-transform duration-200 ease-in-out animate-fade-in"
           [draggable]="editingTaskId !== task.id"
           (dragstart)="onDragStart($event, task)"
           (dragend)="onDragEnd($event)"
           (contextmenu)="openContextMenu($event, task)"
           [class.prio-low]="task.priority === 'Low'"
           [class.prio-medium]="task.priority === 'Medium'"
           [class.prio-high]="task.priority === 'High'">
        <ng-container *ngIf="editingTaskId !== task.id; else editBlock">
          <div (click)="startEdit(task)">
            <!-- Titles removed: show only description -->
            <p class="task-desc">{{ task.description }}</p>
          </div>
        </ng-container>

        <ng-template #editBlock>
          <div class="kanban-edit">
            <!-- Single-line input to feel like editing inline; save on blur/enter, cancel on Escape -->
            <input id="edit-input-{{task.id}}" class="kanban-input" type="text" [(ngModel)]="editedDescription" (keydown.enter)="saveEdit(task)" (keydown.escape)="cancelEdit()" (blur)="saveEdit(task)" />
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<!-- Context menu -->
<div *ngIf="contextMenuVisible" class="context-menu" [style.left.px]="contextMenuX" [style.top.px]="contextMenuY">
  <div class="context-section">
    <div class="context-title">Priority</div>
    <button class="context-item" (click)="setPriorityById(contextMenuTaskId, 'Low')">Low</button>
    <button class="context-item" (click)="setPriorityById(contextMenuTaskId, 'Medium')">Medium</button>
    <button class="context-item" (click)="setPriorityById(contextMenuTaskId, 'High')">High</button>
  </div>
  <div class="context-section">
    <button class="context-item danger" (click)="deleteTaskById(contextMenuTaskId)">Supprimer</button>
  </div>
</div>